name: Apk-snapshot

on:
  workflow_dispatch:

jobs:
  build:
    name: build x86_64 snapshot apk
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add kwrt-packages feed
        run: |
          git clone https://github.com/kiddin9/kwrt-packages package/kwrt-packages

      - name: Build luci packages (APK only)
        uses: sbwml/openwrt-gh-action-sdk@helloworld
        env:
          ARCH: x86_64-snapshot
          FEEDNAME: kwrt_packages
          FEEDS_CONF: |
            src-git kwrt_packages https://github.com/kiddin9/kwrt-packages
          PACKAGES: |
            xmm-modem
            luci-app-adguardhome
            luci-app-disks-info
            luci-theme-argon
            luci-app-argon-config
            luci-app-diskman
            luci-app-internet-detector
            luci-app-poweroffdevice
            luci-app-ramfree
            luci-app-tailscale
          BUILD_APK: true
          BUILD_IPK: false
          NO_REFRESH_CHECK: true

      # ðŸ”¥ FILTER APK (BUANG i18n)
      - name: Prepare APK artifacts (exclude i18n)
        run: |
          mkdir -p release_apk

          find bin/packages/x86_64/kwrt_packages \
            -type f \
            -name "*.apk" \
            ! -name "*i18n*" \
            -exec cp {} release_apk/ \;

          echo "===== APK YANG AKAN DIRELEASE ====="
          ls -lh release_apk

      # (Optional) Upload artifact ke workflow (debug / download manual)
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: apk-no-i18n
          path: release_apk/*.apk

      # ðŸš€ RELEASE (PASTI BERSIH)
      - name: Release APK
        uses: ncipollo/release-action@v1
        with:
          token: ${{ secrets.REALESES_TOKEN }}
          tag: x86_64_apk
          allowUpdates: true
          replacesArtifacts: true
          artifacts: release_apk/*.apk
          body: |
            luci-app-diskman
            Snapshot build (APK only)
            Source feed:
            https://github.com/kiddin9/kwrt-packages

      - name: Cleanup old workflow runs
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 1
          keep_minimum_runs: 0
